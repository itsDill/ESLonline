<!DOCTYPE html>
<html lang="en">
  <head>
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2456627863532019"
      crossorigin="anonymous"
    ></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Story Builder - Collaborative Creative Writing Game | ESL Fun Online
    </title>
    <meta
      name="description"
      content="Create amazing stories with Story Builder! Practice creative writing, improve grammar, and develop storytelling skills through collaborative interactive gameplay."
    />
    <meta
      name="keywords"
      content="story builder game, creative writing practice, ESL writing game, collaborative storytelling, grammar practice, English writing skills"
    />
    <meta name="author" content="ESL Fun Online" />
    <meta name="robots" content="index, follow" />
    <meta
      property="og:title"
      content="Story Builder - Collaborative Creative Writing Game | ESL Fun Online"
    />
    <meta
      property="og:description"
      content="Create collaborative stories with other players! Practice creative writing, grammar, and storytelling in this multiplayer adventure."
    />
    <meta
      property="og:image"
      content="https://eslfunonline.com/images/image copy 9.png"
    />
    <meta
      property="og:url"
      content="https://eslfunonline.com/games/story-builder.html"
    />
    <meta property="og:type" content="game" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="Story Builder - Collaborative Creative Writing Game"
    />
    <meta
      name="twitter:description"
      content="Create collaborative stories and practice creative writing skills!"
    />
    <meta
      name="twitter:image"
      content="https://eslfunonline.com/images/image copy 9.png"
    />
    <link
      rel="canonical"
      href="https://eslfunonline.com/games/story-builder.html"
    />

    <!-- Structured Data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Game",
        "name": "Story Builder - Collaborative Creative Writing Game",
        "description": "Create amazing collaborative stories! Practice creative writing, improve grammar, and develop storytelling skills through interactive gameplay.",
        "url": "https://eslfunonline.com/games/story-builder.html",
        "image": "https://eslfunonline.com/images/image copy 9.png",
        "publisher": {
          "@type": "Organization",
          "name": "ESL Fun Online",
          "url": "https://eslfunonline.com"
        },
        "genre": ["Educational", "Creative Writing", "Storytelling"],
        "audience": {
          "@type": "EducationalAudience",
          "educationalRole": "student",
          "audienceType": "ESL Learners and Creative Writers"
        },
        "educationalLevel": "Intermediate to Advanced",
        "educationalUse": [
          "creative writing practice",
          "grammar improvement",
          "storytelling skills",
          "collaborative learning"
        ],
        "interactivityType": "active",
        "learningResourceType": "game",
        "inLanguage": "en",
        "isAccessibleForFree": true,
        "accessibilityFeature": [
          "alternativeText",
          "fullKeyboardControl",
          "screenReaderSupport"
        ],
        "accessibilityControl": ["fullKeyboardControl", "fullMouseControl"],
        "accessibilityHazard": [
          "noFlashingHazard",
          "noMotionSimulationHazard",
          "noSoundHazard"
        ],
        "keywords": "story builder, creative writing, ESL writing, collaborative storytelling, grammar practice, writing skills, creative game"
      }
    </script>

    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-9G9RD6BHLN"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-9G9RD6BHLN");
    </script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary-color: #46bbe5;
        --primary-hover: #05425c;
        --secondary-color: #f59e0b;
        --accent-color: #10b981;
        --danger-color: #ef4444;
        --success-color: #10b981;
        --purple-color: #8b5cf6;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --bg-primary: #ffffff;
        --bg-secondary: #f9fafb;
        --bg-tertiary: #f3f4f6;
        --border-color: #e5e7eb;
        --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: var(--text-primary);
        padding: 1rem;
      }

      .game-container {
        max-width: 1200px;
        margin: 0 auto;
        background: var(--bg-primary);
        border-radius: 20px;
        box-shadow: var(--shadow-lg);
        padding: 2rem;
      }

      .game-header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .game-header h1 {
        font-family: "Poppins", sans-serif;
        font-size: 2.5rem;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .game-header p {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-bottom: 1rem;
      }

      .story-modes {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }

      .mode-btn {
        padding: 0.75rem 1.5rem;
        border: 2px solid var(--border-color);
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
      }

      .mode-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      .mode-btn:hover {
        transform: translateY(-2px);
      }

      .story-setup {
        background: var(--bg-secondary);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        display: none;
      }

      .story-setup.active {
        display: block;
      }

      .setup-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .setup-card {
        background: var(--bg-primary);
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 2px solid var(--border-color);
      }

      .setup-card:hover {
        transform: translateY(-2px);
        border-color: var(--primary-color);
      }

      .setup-card.selected {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      .setup-card h4 {
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }

      .setup-card p {
        font-size: 0.85rem;
        opacity: 0.8;
      }

      .story-area {
        background: var(--bg-secondary);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        min-height: 400px;
      }

      .story-display {
        background: var(--bg-primary);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        min-height: 300px;
        font-size: 1.1rem;
        line-height: 1.8;
        border: 2px solid var(--border-color);
        max-height: 400px;
        overflow-y: auto;
      }

      .story-paragraph {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        background: var(--bg-secondary);
        position: relative;
      }

      .story-paragraph:nth-child(even) {
        background: rgba(70, 187, 229, 0.05);
      }

      .paragraph-author {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-style: italic;
        margin-bottom: 0.5rem;
      }

      .input-section {
        background: var(--bg-tertiary);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .prompt-display {
        background: var(--primary-color);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        text-align: center;
        font-weight: 600;
      }

      .story-input {
        width: 100%;
        min-height: 120px;
        padding: 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        line-height: 1.6;
        resize: vertical;
        font-family: "Inter", sans-serif;
        margin-bottom: 1rem;
      }

      .story-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(70, 187, 229, 0.1);
      }

      .input-help {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .word-count {
        font-weight: 600;
      }

      .word-count.good {
        color: var(--success-color);
      }

      .word-count.warning {
        color: var(--secondary-color);
      }

      .word-count.error {
        color: var(--danger-color);
      }

      .suggestion-chips {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
      }

      .suggestion-chip {
        background: var(--bg-primary);
        color: var(--text-primary);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.85rem;
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .suggestion-chip:hover {
        background: var(--primary-color);
        color: white;
      }

      .story-stats {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }

      .stat-card {
        background: var(--bg-secondary);
        padding: 1rem 1.5rem;
        border-radius: 15px;
        text-align: center;
        min-width: 120px;
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--primary-color);
      }

      .stat-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .game-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 2rem;
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-primary {
        background: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 2px solid var(--border-color);
      }

      .btn-secondary:hover {
        background: var(--bg-secondary);
        border-color: var(--primary-color);
      }

      .btn-success {
        background: var(--success-color);
        color: white;
      }

      .btn-hint {
        background: var(--secondary-color);
        color: white;
      }

      .btn-danger {
        background: var(--danger-color);
        color: white;
      }

      .story-sharing {
        background: var(--bg-secondary);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        display: none;
      }

      .story-sharing.show {
        display: block;
      }

      .sharing-options {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 1rem;
      }

      .genre-selector {
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 2rem;
      }

      .genre-btn {
        padding: 0.5rem 1rem;
        border: 2px solid var(--border-color);
        background: var(--bg-secondary);
        color: var(--text-primary);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
      }

      .genre-btn.active {
        background: var(--secondary-color);
        color: white;
        border-color: var(--secondary-color);
      }

      .game-message {
        margin: 1rem 0;
        padding: 1rem;
        border-radius: 10px;
        font-weight: 600;
        text-align: center;
        font-size: 1.1rem;
      }

      .message-success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success-color);
        border: 2px solid rgba(16, 185, 129, 0.3);
      }

      .message-info {
        background: rgba(70, 187, 229, 0.1);
        color: var(--primary-color);
        border: 2px solid rgba(70, 187, 229, 0.3);
      }

      .message-warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--secondary-color);
        border: 2px solid rgba(245, 158, 11, 0.3);
      }

      @media (max-width: 768px) {
        .game-container {
          padding: 1rem;
          margin: 0.5rem;
        }

        .game-header h1 {
          font-size: 2rem;
        }

        .setup-grid {
          grid-template-columns: 1fr;
        }

        .story-stats {
          gap: 1rem;
        }

        .stat-card {
          min-width: 100px;
          padding: 0.75rem 1rem;
        }

        .input-help {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }
      }

      /* Accessibility */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }

      button:focus-visible,
      input:focus-visible,
      textarea:focus-visible,
      .mode-btn:focus-visible,
      .theme-option:focus-visible,
      .suggestion:focus-visible {
        outline: 3px solid var(--primary-color);
        outline-offset: 2px;
      }

      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }
    </style>
      <link rel="stylesheet" href="../css/mobile-optimized.css" />

  <body>
    <!-- Google AdSense -->
    <div class="ad-container" style="margin: 1rem auto; max-width: 100%; text-align: center; padding: 0 1rem;">
      <ins class="adsbygoogle"
           style="display: block; text-align: center;"
           data-ad-client="ca-pub-2456627863532019"
           data-ad-slot="1718707782"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>

    <div class="game-container">
      <div class="game-header" role="banner">
        <h1>
          <i class="fas fa-feather-alt" aria-hidden="true"></i> Story Builder
        </h1>
        <p>Create collaborative stories and practice creative writing!</p>
      </div>

      <div class="story-modes" role="tablist" aria-label="Story mode selection">
        <button
          class="mode-btn active"
          data-mode="solo"
          role="tab"
          aria-selected="true"
          aria-controls="storyContent"
        >
          Solo Story
        </button>
        <button
          class="mode-btn"
          data-mode="collaborative"
          role="tab"
          aria-selected="false"
          aria-controls="storyContent"
        >
          Collaborative
        </button>
        <button
          class="mode-btn"
          data-mode="prompt"
          role="tab"
          aria-selected="false"
          aria-controls="storyContent"
        >
          Prompt Challenge
        </button>
      </div>

      <div
        class="genre-selector"
        role="radiogroup"
        aria-label="Story genre selection"
      >
        <button
          class="genre-btn active"
          data-genre="adventure"
          role="radio"
          aria-checked="true"
        >
          Adventure
        </button>
        <button
          class="genre-btn"
          data-genre="mystery"
          role="radio"
          aria-checked="false"
        >
          Mystery
        </button>
        <button
          class="genre-btn"
          data-genre="romance"
          role="radio"
          aria-checked="false"
        >
          Romance
        </button>
        <button
          class="genre-btn"
          data-genre="fantasy"
          role="radio"
          aria-checked="false"
        >
          Fantasy
        </button>
        <button
          class="genre-btn"
          data-genre="scifi"
          role="radio"
          aria-checked="false"
        >
          Sci-Fi
        </button>
        <button
          class="genre-btn"
          data-genre="comedy"
          role="radio"
          aria-checked="false"
        >
          Comedy
        </button>
      </div>

      <div
        class="story-setup"
        id="storySetup"
        role="region"
        aria-label="Story setup"
      >
        <h3>
          <i class="fas fa-cog" aria-hidden="true"></i> Choose Your Story
          Elements
        </h3>
        <div class="setup-grid" id="setupGrid">
          <!-- Setup cards will be populated by JavaScript -->
        </div>
        <div class="game-controls">
          <button
            class="btn btn-primary"
            id="startStoryBtn"
            aria-label="Start creating your story"
          >
            <i class="fas fa-play" aria-hidden="true"></i> Start Story
          </button>
        </div>
      </div>

      <div
        class="story-stats"
        role="status"
        aria-live="polite"
        aria-label="Story statistics"
      >
        <div class="stat-card">
          <div
            class="stat-value"
            id="paragraphCount"
            aria-label="Number of paragraphs"
          >
            0
          </div>
          <div class="stat-label">Paragraphs</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="wordCount" aria-label="Total word count">
            0
          </div>
          <div class="stat-label">Total Words</div>
        </div>
        <div class="stat-card">
          <div
            class="stat-value"
            id="storyScore"
            aria-label="Current story score"
          >
            0
          </div>
          <div class="stat-label">Score</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="genreDisplay" aria-label="Selected genre">
            Adventure
          </div>
          <div class="stat-label">Genre</div>
        </div>
      </div>

      <div
        class="story-area"
        role="main"
        aria-label="Story creation area"
        id="storyContent"
      >
        <div
          class="story-display"
          id="storyDisplay"
          role="article"
          aria-live="polite"
        >
          <p
            style="
              text-align: center;
              color: var(--text-secondary);
              font-style: italic;
            "
          >
            Your story will appear here as you write...
          </p>
        </div>

        <div class="input-section">
          <div
            class="prompt-display"
            id="promptDisplay"
            role="status"
            aria-live="polite"
          >
            Click "Start Story" to begin your creative journey!
          </div>

          <textarea
            class="story-input"
            id="storyInput"
            aria-label="Write your story contribution here"
            placeholder="Write the next part of your story here..."
            disabled
          ></textarea>

          <div class="input-help">
            <span class="word-count" id="inputWordCount" aria-live="polite"
              >0 words</span
            >
            <span class="writing-tip" id="writingTip" role="status"
              >Tip: Use descriptive language!</span
            >
          </div>

          <div
            class="suggestion-chips"
            id="suggestionChips"
            role="group"
            aria-label="Writing suggestions"
          >
            <!-- Writing suggestions will appear here -->
          </div>
        </div>
      </div>

      <div
        class="game-controls"
        role="group"
        aria-label="Story control buttons"
      >
        <button
          class="btn btn-primary"
          id="addParagraphBtn"
          disabled
          aria-label="Add your paragraph to the story"
        >
          <i class="fas fa-plus" aria-hidden="true"></i> Add to Story
        </button>
        <button
          class="btn btn-hint"
          id="hintBtn"
          aria-label="Get a writing hint"
        >
          <i class="fas fa-lightbulb" aria-hidden="true"></i> Writing Hint
        </button>
        <button
          class="btn btn-secondary"
          id="undoBtn"
          disabled
          aria-label="Undo the last paragraph"
        >
          <i class="fas fa-undo" aria-hidden="true"></i> Undo Last
        </button>
        <button
          class="btn btn-success"
          id="finishStoryBtn"
          disabled
          aria-label="Finish and complete your story"
        >
          <i class="fas fa-check" aria-hidden="true"></i> Finish Story
        </button>
      </div>

      <div
        class="story-sharing"
        id="storySharing"
        role="region"
        aria-label="Story sharing options"
      >
        <h3>
          <i class="fas fa-share" aria-hidden="true"></i> Share Your Story
        </h3>
        <p>Great job completing your story! Here are your sharing options:</p>
        <div class="sharing-options">
          <button
            class="btn btn-primary"
            id="copyStoryBtn"
            aria-label="Copy story text to clipboard"
          >
            <i class="fas fa-copy" aria-hidden="true"></i> Copy Text
          </button>
          <button
            class="btn btn-secondary"
            id="saveStoryBtn"
            aria-label="Save story to file"
          >
            <i class="fas fa-save" aria-hidden="true"></i> Save Story
          </button>
          <button
            class="btn btn-hint"
            id="printStoryBtn"
            aria-label="Print your story"
          >
            <i class="fas fa-print" aria-hidden="true"></i> Print Story
          </button>
        </div>
      </div>

      <div
        class="game-message"
        id="gameMessage"
        style="display: none"
        role="alert"
        aria-live="assertive"
      ></div>

      <div
        class="game-controls"
        role="navigation"
        aria-label="Navigation buttons"
      >
        <button
          class="btn btn-success"
          id="newStoryBtn"
          aria-label="Start a new story"
        >
          <i class="fas fa-file-alt" aria-hidden="true"></i> New Story
        </button>
        <button
          class="btn btn-secondary"
          onclick="window.location.href='games.html'"
          aria-label="Go back to games menu"
        >
          <i class="fas fa-arrow-left" aria-hidden="true"></i> Back to Games
        </button>
      </div>
    </div>

    <script>
      class StoryBuilderGame {
        constructor() {
          this.currentMode = "solo";
          this.currentGenre = "adventure";
          this.story = [];
          this.storyElements = {};
          this.paragraphCount = 0;
          this.totalWords = 0;
          this.score = 0;
          this.currentPrompt = "";
          this.isStoryStarted = false;
          this.currentStreak = 0;
          this.bestStreak = parseInt(
            localStorage.getItem("sb_bestStreak") || "0"
          );

          // Stats tracking
          this.stats = {
            storiesCompleted: parseInt(
              localStorage.getItem("sb_storiesCompleted") || "0"
            ),
            totalParagraphs: parseInt(
              localStorage.getItem("sb_totalParagraphs") || "0"
            ),
            totalWords: parseInt(localStorage.getItem("sb_totalWords") || "0"),
            bestStreak: parseInt(localStorage.getItem("sb_bestStreak") || "0"),
          };

          // Audio context for sound effects
          this.audioContext = null;
          this.soundEnabled = true;

          this.initAudio();

          this.storySetups = {
            adventure: {
              characters: [
                "brave explorer",
                "mysterious guide",
                "young adventurer",
                "experienced captain",
              ],
              settings: [
                "ancient temple",
                "dense jungle",
                "mysterious island",
                "hidden cave",
              ],
              objects: [
                "treasure map",
                "magic compass",
                "ancient artifact",
                "glowing crystal",
              ],
              conflicts: [
                "dangerous trap",
                "rival treasure hunters",
                "wild animals",
                "natural disaster",
              ],
            },
            mystery: {
              characters: [
                "detective",
                "suspicious butler",
                "worried client",
                "mysterious stranger",
              ],
              settings: [
                "old mansion",
                "foggy street",
                "abandoned warehouse",
                "quiet library",
              ],
              objects: [
                "cryptic letter",
                "strange key",
                "old photograph",
                "bloodstained cloth",
              ],
              conflicts: [
                "missing person",
                "stolen jewels",
                "unexplained death",
                "family secret",
              ],
            },
            romance: {
              characters: [
                "shy artist",
                "confident lawyer",
                "caring teacher",
                "charming musician",
              ],
              settings: [
                "cozy café",
                "beautiful park",
                "busy airport",
                "quiet beach",
              ],
              objects: [
                "love letter",
                "red rose",
                "favorite book",
                "old photo",
              ],
              conflicts: [
                "misunderstanding",
                "distance",
                "disapproving family",
                "career choice",
              ],
            },
            fantasy: {
              characters: [
                "young wizard",
                "brave knight",
                "wise elf",
                "powerful dragon",
              ],
              settings: [
                "magical forest",
                "ancient castle",
                "crystal cave",
                "floating city",
              ],
              objects: [
                "magic sword",
                "spell book",
                "healing potion",
                "enchanted ring",
              ],
              conflicts: [
                "evil sorcerer",
                "cursed kingdom",
                "dangerous quest",
                "magical plague",
              ],
            },
            scifi: {
              characters: [
                "space explorer",
                "robot companion",
                "alien diplomat",
                "time traveler",
              ],
              settings: [
                "space station",
                "alien planet",
                "future city",
                "laboratory",
              ],
              objects: [
                "laser weapon",
                "time device",
                "alien artifact",
                "hologram",
              ],
              conflicts: [
                "alien invasion",
                "time paradox",
                "robot rebellion",
                "space storm",
              ],
            },
            comedy: {
              characters: [
                "clumsy waiter",
                "overly serious boss",
                "chatty neighbor",
                "confused tourist",
              ],
              settings: [
                "busy restaurant",
                "office building",
                "shopping mall",
                "airport",
              ],
              objects: [
                "slippery banana",
                "broken elevator",
                "wrong suitcase",
                "talking parrot",
              ],
              conflicts: [
                "mistaken identity",
                "embarrassing situation",
                "communication error",
                "silly accident",
              ],
            },
          };

          this.writingPrompts = {
            opening: [
              "Start with a character discovering something unexpected",
              "Begin with dialogue between two characters",
              "Open with a description of an interesting place",
              "Start with a character in a difficult situation",
            ],
            middle: [
              "Introduce a new character or complication",
              "Reveal something important about a character",
              "Show how characters react to the main conflict",
              "Add tension or raise the stakes",
            ],
            ending: [
              "Show how the main conflict is resolved",
              "Reveal what the characters learned",
              "End with a satisfying conclusion",
              "Leave the reader with something to think about",
            ],
          };

          this.writingTips = [
            "Use all five senses in your descriptions",
            "Show emotions through actions, not just words",
            "Vary your sentence length for better flow",
            "Use specific, concrete details",
            "Make your dialogue sound natural",
            "Create vivid settings that enhance the mood",
            "Give your characters clear motivations",
            "Use active voice when possible",
          ];

          this.vocabularySuggestions = {
            emotions: [
              "excited",
              "nervous",
              "curious",
              "determined",
              "worried",
              "hopeful",
            ],
            actions: [
              "whispered",
              "grabbed",
              "stumbled",
              "discovered",
              "searched",
              "realized",
            ],
            descriptions: [
              "mysterious",
              "ancient",
              "glowing",
              "weathered",
              "elegant",
              "towering",
            ],
            transitions: [
              "suddenly",
              "meanwhile",
              "however",
              "therefore",
              "consequently",
              "nevertheless",
            ],
          };

          this.init();
        }

        // Initialize audio context
        initAudio() {
          if (!this.audioContext) {
            this.audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
          }
        }

        // Play sound effect
        playSound(type) {
          if (!this.soundEnabled || !this.audioContext) return;

          const oscillator = this.audioContext.createOscillator();
          const gainNode = this.audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(this.audioContext.destination);

          switch (type) {
            case "success":
              oscillator.frequency.setValueAtTime(
                523.25,
                this.audioContext.currentTime
              );
              oscillator.frequency.setValueAtTime(
                659.25,
                this.audioContext.currentTime + 0.1
              );
              gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                this.audioContext.currentTime + 0.2
              );
              oscillator.start(this.audioContext.currentTime);
              oscillator.stop(this.audioContext.currentTime + 0.2);
              break;
            case "add":
              oscillator.frequency.setValueAtTime(
                440,
                this.audioContext.currentTime
              );
              gainNode.gain.setValueAtTime(0.2, this.audioContext.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                this.audioContext.currentTime + 0.15
              );
              oscillator.start(this.audioContext.currentTime);
              oscillator.stop(this.audioContext.currentTime + 0.15);
              break;
            case "complete":
              oscillator.frequency.setValueAtTime(
                523.25,
                this.audioContext.currentTime
              );
              oscillator.frequency.setValueAtTime(
                659.25,
                this.audioContext.currentTime + 0.15
              );
              oscillator.frequency.setValueAtTime(
                783.99,
                this.audioContext.currentTime + 0.3
              );
              oscillator.frequency.setValueAtTime(
                1046.5,
                this.audioContext.currentTime + 0.45
              );
              gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
              gainNode.gain.exponentialRampToValueAtTime(
                0.01,
                this.audioContext.currentTime + 0.6
              );
              oscillator.start(this.audioContext.currentTime);
              oscillator.stop(this.audioContext.currentTime + 0.6);
              break;
          }
        }

        // Screen reader announcements
        announceToScreenReader(message) {
          const announcement = document.createElement("div");
          announcement.className = "sr-only";
          announcement.setAttribute("role", "status");
          announcement.setAttribute("aria-live", "polite");
          announcement.textContent = message;
          document.body.appendChild(announcement);
          setTimeout(() => announcement.remove(), 1000);
        }

        // Save stats to localStorage
        saveStats() {
          localStorage.setItem(
            "sb_storiesCompleted",
            this.stats.storiesCompleted.toString()
          );
          localStorage.setItem(
            "sb_totalParagraphs",
            this.stats.totalParagraphs.toString()
          );
          localStorage.setItem(
            "sb_totalWords",
            this.stats.totalWords.toString()
          );
          localStorage.setItem(
            "sb_bestStreak",
            this.stats.bestStreak.toString()
          );
        }

        // Update streak tracking
        updateStreak(added) {
          if (added) {
            this.currentStreak++;
            if (this.currentStreak > this.bestStreak) {
              this.bestStreak = this.currentStreak;
              this.stats.bestStreak = this.bestStreak;
              this.saveStats();
              this.announceToScreenReader(
                `New best streak: ${this.bestStreak} paragraphs!`
              );
            }
          } else {
            this.currentStreak = 0;
          }
        }

        init() {
          this.setupEventListeners();
          this.showSetup();
          this.updateStats();
        }

        setupEventListeners() {
          // Mode selection
          document.querySelectorAll(".mode-btn").forEach((btn) => {
            btn.onclick = () => {
              document.querySelectorAll(".mode-btn").forEach((b) => {
                b.classList.remove("active");
                b.setAttribute("aria-selected", "false");
              });
              btn.classList.add("active");
              btn.setAttribute("aria-selected", "true");
              this.currentMode = btn.dataset.mode;
              this.showSetup();
              this.announceToScreenReader(`Mode changed to ${btn.textContent}`);
            };
          });

          // Genre selection
          document.querySelectorAll(".genre-btn").forEach((btn) => {
            btn.onclick = () => {
              document.querySelectorAll(".genre-btn").forEach((b) => {
                b.classList.remove("active");
                b.setAttribute("aria-checked", "false");
              });
              btn.classList.add("active");
              btn.setAttribute("aria-checked", "true");
              this.currentGenre = btn.dataset.genre;
              this.showSetup();
              this.updateStats();
              this.announceToScreenReader(
                `Genre changed to ${btn.textContent}`
              );
            };
          });

          // Story controls
          document.getElementById("startStoryBtn").onclick = () =>
            this.startStory();
          document.getElementById("addParagraphBtn").onclick = () =>
            this.addParagraph();
          document.getElementById("hintBtn").onclick = () =>
            this.showWritingHint();
          document.getElementById("undoBtn").onclick = () =>
            this.undoLastParagraph();
          document.getElementById("finishStoryBtn").onclick = () =>
            this.finishStory();
          document.getElementById("newStoryBtn").onclick = () =>
            this.startNewStory();

          // Input handling
          const storyInput = document.getElementById("storyInput");
          storyInput.addEventListener("input", () =>
            this.updateInputWordCount()
          );
          storyInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && e.ctrlKey) {
              e.preventDefault();
              this.addParagraph();
            }
          });

          // Keyboard shortcuts
          document.addEventListener("keydown", (e) => {
            // Ctrl+Enter to add paragraph
            if (
              e.ctrlKey &&
              e.key === "Enter" &&
              !document.getElementById("addParagraphBtn").disabled
            ) {
              e.preventDefault();
              this.addParagraph();
            }
            // Ctrl+H for hint
            if (e.ctrlKey && e.key === "h") {
              e.preventDefault();
              this.showWritingHint();
            }
            // Ctrl+Z for undo
            if (
              e.ctrlKey &&
              e.key === "z" &&
              !document.getElementById("undoBtn").disabled
            ) {
              e.preventDefault();
              this.undoLastParagraph();
            }
            // Escape to finish story
            if (
              e.key === "Escape" &&
              !document.getElementById("finishStoryBtn").disabled
            ) {
              this.finishStory();
            }
          });

          // Sharing
          document.getElementById("copyStoryBtn").onclick = () =>
            this.copyStory();
          document.getElementById("saveStoryBtn").onclick = () =>
            this.saveStory();
          document.getElementById("printStoryBtn").onclick = () =>
            this.printStory();

          // Suggestion chips
          document
            .getElementById("suggestionChips")
            .addEventListener("click", (e) => {
              if (e.target.classList.contains("suggestion-chip")) {
                this.insertSuggestion(e.target.textContent);
              }
            });
        }

        showSetup() {
          const setup = document.getElementById("storySetup");
          const grid = document.getElementById("setupGrid");

          if (this.isStoryStarted) {
            setup.classList.remove("active");
            return;
          }

          setup.classList.add("active");
          grid.innerHTML = "";

          const setupData = this.storySetups[this.currentGenre];

          Object.keys(setupData).forEach((category) => {
            const categoryDiv = document.createElement("div");
            categoryDiv.setAttribute("role", "radiogroup");
            categoryDiv.setAttribute(
              "aria-label",
              `${
                category.charAt(0).toUpperCase() + category.slice(1)
              } selection`
            );
            categoryDiv.innerHTML = `
                        <h4 style="margin-bottom: 1rem; text-align: center; color: var(--primary-color);">
                            ${
                              category.charAt(0).toUpperCase() +
                              category.slice(1)
                            }
                        </h4>
                    `;

            setupData[category].forEach((item) => {
              const card = document.createElement("div");
              card.className = "setup-card";
              card.setAttribute("role", "radio");
              card.setAttribute("aria-checked", "false");
              card.setAttribute("aria-label", item);
              card.setAttribute("tabindex", "0");
              card.innerHTML = `
                            <h4>${item}</h4>
                            <p>Click to select</p>
                        `;
              card.onclick = () =>
                this.selectStoryElement(category, item, card);
              card.onkeypress = (e) => {
                if (e.key === "Enter" || e.key === " ") {
                  e.preventDefault();
                  this.selectStoryElement(category, item, card);
                }
              };
              categoryDiv.appendChild(card);
            });

            grid.appendChild(categoryDiv);
          });
        }

        selectStoryElement(category, item, cardElement) {
          // Deselect other cards in the same category
          const categoryCards =
            cardElement.parentElement.querySelectorAll(".setup-card");
          categoryCards.forEach((card) => {
            card.classList.remove("selected");
            card.setAttribute("aria-checked", "false");
          });

          // Select this card
          cardElement.classList.add("selected");
          cardElement.setAttribute("aria-checked", "true");
          this.storyElements[category] = item;
          this.announceToScreenReader(`Selected ${item} for ${category}`);
        }

        startStory() {
          const requiredElements = [
            "characters",
            "settings",
            "objects",
            "conflicts",
          ];
          const missing = requiredElements.filter(
            (elem) => !this.storyElements[elem]
          );

          if (missing.length > 0) {
            this.showMessage(`Please select: ${missing.join(", ")}`, "warning");
            return;
          }

          this.isStoryStarted = true;
          this.currentStreak = 0;
          document.getElementById("storySetup").classList.remove("active");
          document.getElementById("storyInput").disabled = false;
          document.getElementById("addParagraphBtn").disabled = false;
          document.getElementById("finishStoryBtn").disabled = false;

          this.generateOpeningPrompt();
          this.updateSuggestions();
          this.showMessage(
            "🎉 Story started! Begin writing your opening paragraph.",
            "success"
          );
          this.playSound("success");
          this.announceToScreenReader(
            "Story started! You can now write your first paragraph. Press Ctrl+Enter to add it to the story."
          );
        }

        generateOpeningPrompt() {
          const character = this.storyElements.characters;
          const setting = this.storyElements.settings;
          const object = this.storyElements.objects;

          const prompts = [
            `Write about a ${character} who discovers a ${object} in a ${setting}.`,
            `Describe how a ${character} arrives at a ${setting} looking for a ${object}.`,
            `Start with a ${character} examining a mysterious ${object} in a ${setting}.`,
            `Begin with a ${character} who must find a ${object} hidden in a ${setting}.`,
          ];

          this.currentPrompt =
            prompts[Math.floor(Math.random() * prompts.length)];
          this.updatePromptDisplay();
        }

        updatePromptDisplay() {
          document.getElementById("promptDisplay").textContent =
            this.currentPrompt;
        }

        addParagraph() {
          const input = document.getElementById("storyInput");
          const text = input.value.trim();

          if (text.length < 20) {
            this.showMessage(
              "Please write at least 20 characters for your paragraph.",
              "warning"
            );
            return;
          }

          const paragraph = {
            text: text,
            author: "You",
            wordCount: text.split(/\s+/).length,
            timestamp: new Date(),
          };

          this.story.push(paragraph);
          this.updateStoryDisplay();
          this.updateStats();
          this.generateNextPrompt();

          input.value = "";
          this.updateInputWordCount();
          this.updateSuggestions();

          document.getElementById("undoBtn").disabled = false;

          const points = Math.min(paragraph.wordCount * 2, 100);
          this.score += points;
          this.updateStats();
          this.updateStreak(true);

          this.playSound("add");
          this.announceToScreenReader(
            `Paragraph added! ${paragraph.wordCount} words. Score increased by ${points} points. Current streak: ${this.currentStreak}`
          );

          this.showMessage(
            `Great! Added ${paragraph.wordCount} words. (+${points} points) Streak: ${this.currentStreak}`,
            "success"
          );
        }

        updateStoryDisplay() {
          const display = document.getElementById("storyDisplay");

          if (this.story.length === 0) {
            display.innerHTML = `
                        <p style="text-align: center; color: var(--text-secondary); font-style: italic;">
                            Your story will appear here as you write...
                        </p>
                    `;
            return;
          }

          display.innerHTML = this.story
            .map(
              (paragraph, index) => `
                    <div class="story-paragraph">
                        <div class="paragraph-author">Paragraph ${
                          index + 1
                        } - ${paragraph.author}</div>
                        <div>${paragraph.text}</div>
                    </div>
                `
            )
            .join("");

          display.scrollTop = display.scrollHeight;
        }

        generateNextPrompt() {
          const storyLength = this.story.length;
          let promptType = "middle";

          if (storyLength === 1) {
            promptType = "middle";
          } else if (storyLength >= 4) {
            promptType = Math.random() > 0.5 ? "middle" : "ending";
          }

          const prompts = this.writingPrompts[promptType];
          this.currentPrompt =
            prompts[Math.floor(Math.random() * prompts.length)];
          this.updatePromptDisplay();
        }

        updateInputWordCount() {
          const input = document.getElementById("storyInput");
          const wordCount = input.value.trim()
            ? input.value.trim().split(/\s+/).length
            : 0;
          const counter = document.getElementById("inputWordCount");

          counter.textContent = `${wordCount} words`;

          if (wordCount < 10) {
            counter.className = "word-count";
          } else if (wordCount < 30) {
            counter.className = "word-count good";
          } else if (wordCount < 50) {
            counter.className = "word-count warning";
          } else {
            counter.className = "word-count error";
          }
        }

        updateSuggestions() {
          const container = document.getElementById("suggestionChips");
          container.innerHTML = "";

          const categories = Object.keys(this.vocabularySuggestions);
          const randomCategory =
            categories[Math.floor(Math.random() * categories.length)];
          const suggestions = this.vocabularySuggestions[randomCategory];

          suggestions.slice(0, 6).forEach((word) => {
            const chip = document.createElement("span");
            chip.className = "suggestion-chip";
            chip.textContent = word;
            container.appendChild(chip);
          });
        }

        insertSuggestion(word) {
          const input = document.getElementById("storyInput");
          const cursorPosition = input.selectionStart;
          const textBefore = input.value.substring(0, cursorPosition);
          const textAfter = input.value.substring(cursorPosition);

          const wordToInsert =
            (textBefore && !textBefore.endsWith(" ") ? " " : "") +
            word +
            (textAfter && !textAfter.startsWith(" ") ? " " : "");

          input.value = textBefore + wordToInsert + textAfter;
          input.focus();
          input.selectionStart = input.selectionEnd =
            cursorPosition + wordToInsert.length;
          this.updateInputWordCount();
        }

        showWritingHint() {
          const tips = this.writingTips;
          const randomTip = tips[Math.floor(Math.random() * tips.length)];
          this.showMessage(`💡 Writing Tip: ${randomTip}`, "info");
        }

        undoLastParagraph() {
          if (this.story.length === 0) return;

          const removed = this.story.pop();
          this.updateStoryDisplay();
          this.updateStats();

          if (this.story.length === 0) {
            document.getElementById("undoBtn").disabled = true;
            this.generateOpeningPrompt();
          } else {
            this.generateNextPrompt();
          }

          this.showMessage(
            `Removed paragraph with ${removed.wordCount} words.`,
            "info"
          );
        }

        finishStory() {
          if (this.story.length < 2) {
            this.showMessage(
              "Write at least 2 paragraphs before finishing your story.",
              "warning"
            );
            return;
          }

          const bonusPoints = this.story.length * 50;
          this.score += bonusPoints;

          // Update global stats
          this.stats.storiesCompleted++;
          this.stats.totalParagraphs += this.story.length;
          const storyWords = this.story.reduce(
            (sum, p) => sum + p.wordCount,
            0
          );
          this.stats.totalWords += storyWords;
          this.saveStats();

          this.updateStats();

          document.getElementById("storySharing").classList.add("show");
          document.getElementById("addParagraphBtn").disabled = true;
          document.getElementById("finishStoryBtn").disabled = true;
          document.getElementById("storyInput").disabled = true;

          this.playSound("complete");
          this.announceToScreenReader(
            `Story completed! ${this.story.length} paragraphs, ${storyWords} words. Final score: ${this.score}. Best streak: ${this.bestStreak}`
          );

          this.showMessage(
            `🎉 Story completed! Bonus: ${bonusPoints} points. Total: ${this.score}! Best streak: ${this.bestStreak}`,
            "success"
          );
        }

        startNewStory() {
          this.story = [];
          this.storyElements = {};
          this.paragraphCount = 0;
          this.totalWords = 0;
          this.score = 0;
          this.currentStreak = 0;
          this.isStoryStarted = false;

          this.updateStoryDisplay();
          this.updateStats();
          this.showSetup();

          document.getElementById("storySharing").classList.remove("show");
          document.getElementById("storyInput").disabled = true;
          document.getElementById("addParagraphBtn").disabled = true;
          document.getElementById("finishStoryBtn").disabled = true;
          document.getElementById("undoBtn").disabled = true;

          document.getElementById("promptDisplay").textContent =
            'Click "Start Story" to begin your creative journey!';
          document.getElementById("storyInput").value = "";
          this.updateInputWordCount();

          this.announceToScreenReader(
            "New story started. Select your story elements to begin."
          );
          this.showMessage("✨ Ready to create a new story!", "info");
        }

        copyStory() {
          const storyText = this.story.map((p) => p.text).join("\n\n");
          const title = `My ${
            this.currentGenre.charAt(0).toUpperCase() +
            this.currentGenre.slice(1)
          } Story`;
          const fullText = `${title}\n\n${storyText}`;

          navigator.clipboard
            .writeText(fullText)
            .then(() => {
              this.showMessage("📋 Story copied to clipboard!", "success");
              this.announceToScreenReader(
                "Story copied to clipboard successfully"
              );
            })
            .catch(() => {
              this.showMessage("Could not copy story to clipboard.", "warning");
              this.announceToScreenReader("Failed to copy story to clipboard");
            });
        }

        saveStory() {
          const storyText = this.story.map((p) => p.text).join("\n\n");
          const title = `My ${
            this.currentGenre.charAt(0).toUpperCase() +
            this.currentGenre.slice(1)
          } Story`;
          const fullText = `${title}\n\n${storyText}`;

          const blob = new Blob([fullText], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `story-${Date.now()}.txt`;
          a.click();
          URL.revokeObjectURL(url);

          this.showMessage("💾 Story downloaded!", "success");
          this.announceToScreenReader("Story file downloaded successfully");
        }

        printStory() {
          const storyText = this.story.map((p) => p.text).join("\n\n");
          const title = `My ${
            this.currentGenre.charAt(0).toUpperCase() +
            this.currentGenre.slice(1)
          } Story`;

          const printWindow = window.open("", "_blank");
          printWindow.document.write(`
                    <html>
                        <head>
                            <title>${title}</title>
                            <style>
                                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; }
                                h1 { color: #333; border-bottom: 2px solid #46bbe5; padding-bottom: 1rem; }
                                p { line-height: 1.8; margin-bottom: 1rem; text-align: justify; }
                            </style>
                        </head>
                        <body>
                            <h1>${title}</h1>
                            <div>${storyText
                              .split("\n\n")
                              .map((p) => `<p>${p}</p>`)
                              .join("")}</div>
                        </body>
                    </html>
                `);
          printWindow.document.close();
          printWindow.print();
        }

        updateStats() {
          this.paragraphCount = this.story.length;
          this.totalWords = this.story.reduce((sum, p) => sum + p.wordCount, 0);

          document.getElementById("paragraphCount").textContent =
            this.paragraphCount;
          document.getElementById("wordCount").textContent = this.totalWords;
          document.getElementById("storyScore").textContent = this.score;
          document.getElementById("genreDisplay").textContent =
            this.currentGenre.charAt(0).toUpperCase() +
            this.currentGenre.slice(1);
        }

        showMessage(text, type) {
          const message = document.getElementById("gameMessage");
          message.textContent = text;
          message.className = `game-message message-${type}`;
          message.style.display = "block";

          setTimeout(() => {
            message.style.display = "none";
          }, 4000);
        }
      }

      // Initialize game when page loads
      document.addEventListener("DOMContentLoaded", () => {
        new StoryBuilderGame();
      });
    </script>
  
    <!-- Google AdSense -->
    <div class="ad-container" style="margin: 1rem auto; max-width: 100%; text-align: center; padding: 0 1rem;">
      <ins class="adsbygoogle"
           style="display: block; text-align: center;"
           data-ad-client="ca-pub-2456627863532019"
           data-ad-slot="1718707782"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
      <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
    </div>

  </body>
</html>
